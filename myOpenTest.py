#!/usr/bin/python2.7 -3
#-*- coding: utf-8 -*-

#
# (c) Raphael Jacquot 2014
# Licenced under the terms of the GNU GPL v3.0 or later
#

import config
import myOpenLayer1
import myOpenTempControl
import re

class MyOpenApplication (object) :
    COMMAND = 0
    STATUS  = 1
    MSG_TYPES = [ 'Command', 'Status', ]

    def __init__ (self) :
        # prepare the app startup
        self.routes = [ { '1' : self.cmd_lighting, },
                        { '4' : self.status_tempcontrol}, ]

        # create the system loop
        self.system_loop = myOpenLayer1.MainLoop(myOpenLayer1.system_logger)
        # open the monitor socket to the gateway
        self.monitor_socket = myOpenLayer1.OwnSocket(
                config.host,
                config.port,
                config.password,
                myOpenLayer1.OwnSocket.MONITOR)
        # set the callback to get messages from the layer 1
        self.monitor_socket.set_data_callback(self.data_callback)
        # add the monitor socket to the system loop
        self.system_loop.add_socket(self.monitor_socket)
        # run the system loop.
        self.system_loop.run()

    def get_number (self, msg) :
        v = '' 
        while True :
            if len(msg) == 0 :
                break
            c = msg[0]
            if c >= '0' and c <= '9' :
                v += c
                msg = msg[1:]
            else :
                break
        return v, msg

    def data_callback (self, msg) :
        msgtype = None
        # analyze the content of messages passed from the layer 1
        m = re.match('^\*(?P<who>\d+)(?P<msg>\*.*)', msg)
        if m is not None :
            msgtype = self.COMMAND
        else :
            m = re.match('^\*#(?P<who>\d+)(?P<msg>\*.*)', msg)
            if m is not None :
                msgtype = self.STATUS
        if msgtype is not None :
            r = self.routes[msgtype]
            who, msg = m.groups()
            if who in r :
                func = r[who]
                if func is not None :
                    func (msg)
                    return
            msg = 'found '+self.MSG_TYPES[msgtype]+' message \''+who+'\' remains \''+msg+'\''
        else :
            msg = 'Unknown first character in message '+msg
        # log something
        self.monitor_socket.log (msg)

    # Lighting systems

    def cmd_lighting (self, msg) :
        self.monitor_socket.log ('lighting command '+msg)

    # Temperature control systems

    def status_tempcontrol (self, msg) :
        # temperature report
        # '101*0*0270##'
        m = re.match('^\*(?P<probe>\d{3})\*0\*(?P<temperature>\d{4})##$',msg)
        if m is not None :
            self.monitor_socket.log (unicode(m.groupdict()))
            return
        self.monitor_socket.log ('temp control status '+msg)

# main program
if __name__ == '__main__' :
    # create the application object, run the main loop
    MyOpenApplication ()
